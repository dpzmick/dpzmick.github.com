<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ants &#8211; dpzmick.com</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Just some dude's blog">
    <meta name="author" content="David Zmick">
    <meta name="keywords" content="">
    <link rel="canonical" href="http://dpzmick.com/2015/06/09/ants/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css" type="text/css">

    <!-- MathJax config -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax:        ["input/TeX", "output/HTML-CSS"],
        tex2jax:    {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true
        },
        "HTML-CSS": {
             availableFonts:
             ["TeX"]
        }
    });
    </script>

    <!-- Fonts -->
    <link href='//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
    
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Ants">
    <meta property="og:description" content="">
    <meta property="og:url" content="http://dpzmick.com/2015/06/09/ants/">
    <meta property="og:site_name" content="dpzmick.com">

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32">
</head>

<body class="">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://dpzmick.com" class="site-title">dpzmick.com</a>
      <nav class="site-nav right">
        <a href="/about/">About</a>
<a href="http://dpzmick.com/resume/resume.pdf">Resume</a>
<a href="/contact/">Contact</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/dpzmick"></a>
    
    
    <a class="fa fa-rss" href="/feed.xml"></a>
    
    
    
      <a class="fa fa-envelope" href="contact/"></a>
    
    
      <a class="fa fa-linkedin" href="https://www.linkedin.com/in/dpzmick"></a>
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  <h1>Ants</h1>
  <span class="post-meta">Jun 9, 2015</span><br>
  
  <span class="post-meta small">12 minute read</span>
</div>

<article class="post-content">
  <h1 id="work-in-progress">WORK IN PROGRESS</h1>

<p>For my four week CS242 final project, I wanted to do something with Erlang to
fiddle around with its concurrency model. Also, I like to simulate things.</p>

<p>Initially I thought I would try to write a traffic simulator but, after a very
useful conversation with a friend of mine, decided on something different.</p>

<p>Ants are cool. Individually they are not super clever, but as a group they can
do things like find food and not die. So, you might be able to think of ants as
a bunch of stupid actors running around and interacting in some way. This seems
like it might be at least an interesting fit for Erlang’s actor model.</p>

<p>Let’s start with a video:</p>

<p>In this video we have an XXXXXX by YYYYY grid with AAAAAA ants running around
on it. The ants all start at the upper edge of the grid then start moving
around.</p>

<p>There is food at (XXX,YYY).</p>

<h2 id="model">Model</h2>
<p>I’ve attempted to capture two behaviors of real ants with my simulation. Ants
want to find food, and they communicate using pheromones (scents).</p>

<p>In my model, pheromones are a way for an ant to communicate to other ants that
they might want to move in a certain direction. Every cell in the simulation has
a pheromone weight indicating the strength of the pheromones at that cell.</p>

<p>An ant can move to either its north, south, east, or west neighbor. To decide
which direction to go, the ant looks at the pheromone strength at each of its
neighboring cells, and the distance the neighboring cell is from the ant’s
starting location (more on this is a sec).</p>

<p>The ant computes the probability that it will move to each of its neighboring
cells, then picks one with those computed probabilities.</p>

<p>I like my ants like I like my editors: modal. They can be in “away from home”
mode or “towards home” mode. Ants know the absolute coordinates of its starting
cell. When an ant starts moving, it favors moving away from its starting cell.
When it finds food, it switches modes and favors moving towards its starting
cell. If it ever reaches the starting cell, it switches modes again and goes to
find more food.</p>

<p>Every time an ant is prepared to move, it performs the pheromone propagation
step.</p>

<h2 id="pheromone-propagation">Pheromone Propagation</h2>
<p>The mechanism I’ve used here is pretty naive (surprise surprise).</p>

<p>When an ant is at a given cell, it gets the max pheromone weight of its four
(north, south, east, and west) neighbors. It then checks if the weight of the
cell it is currently on is greater than the max weight of its neighbors. If the
current cell is weighted more heavily (stronger scent), it does nothing. If its
current cell has a lower pheromone value than the max of its neighbors, it
updates the weight of the current cell to half of the weight of its neighbors.</p>

<p>When ants find food, they set the pheromone weight at the cell which the food
was on to a high value, then they start trying to return to their starting
location. This should, in theory, cause the pheromone trail to follow them. This
sort of works, but I’ve found that the strength of the trail drops off too
quickly. I should use something a bit less naive that neighbor max divided by
two for the cell’s new value.</p>

<p>After updating the cell value, the ant moves to a new cell.</p>

<p>The good thing about this trick is that I can avoid having to make the ants
think much about pheromone propagation. When an ant finds food, all it has to do
is mark that cell with a high weight and change directions. It does not have to
start thinking about leaving a trail behind it as it moves back home because the
automatic cell weight update step will take care of that.</p>

<p>I wrote a tool to visualize the pheromone values left at the end of the
simulation. The following image a zoomed in view of the pheromone values near
the food in the simulation I showed a video of earlier:</p>

<p>SCENT VIS GOES HERE</p>

<h2 id="the-erlang-stuff">The Erlang Stuff</h2>
<p>If you aren’t familiar with Erlang, here is a super quick overview of the
concurrency construct in the language.</p>

<p>Actors (processes in Erlang terminology) run concurrently (and in parallel if
you have multiple CPUS and a modern Erlang VM) and send messages to each other.
These messages are asynchronous, so if actor A sends a message to actor B, it
doesn’t wait for B to respond to proceed with what it is doing (unless you make
it). There is no way for actors to communicate other than sending messages to
each other.</p>

<p>To handle the messages, every actor has a “mailbox” of incoming messages. When
it is ready to receive a message, an actor initiates a message receive, which
pulls messages out of the mailbox and deals with them.</p>

<p>The system is obviously a bit more complicated than that, but for now this is
about all we need to understand.</p>

<p>My Erlang code creates two main types of actors: an ant and a cell.</p>

<p>Cells know who their neighbors are, their weight, if they have food on them, and
the current ant (can be undefined) occupying the cell. Only one ant can occupy a
given cell at any moment in time.</p>

<p>A cell knows how to handle the following messages:</p>

<ul>
  <li>who_are_your_neighbors - asks the cell to send a message back with its
neighbors</li>
  <li>move_me_to_you - tells the cell to set its current occupant to the ant sending
the message</li>
  <li>ive_left - tells the cell that the ant sending the message has left the cell</li>
  <li>some other logistical things that are not important here</li>
</ul>

<p>Ants know what cell they are on, what direction they are going, where they
started, and a few other less important things.</p>

<p>Ants know how to these messages:</p>

<ul>
  <li>wakeup_and_move - tells the ant to try to move somewhere</li>
  <li>neighbors - a message sent to an ant by a cell when the cell reports who its
neighbors are</li>
  <li>move_to - tells an ant to change its current cell to some other cell</li>
  <li>move_failed - tells an ant that its move failed</li>
  <li>some more logistical things that aren’t important here</li>
</ul>

<h3 id="simulation">Simulation</h3>
<p>When the simulator starts, it loads a config file specifying things like the
size of the grid and the location of food, builds the grid of cells, puts ants
on the upper edge of the board, then starts a wakeup_and_move_loop for each ant.</p>

<p>Simply put, these loops tell their ant to wake up and perform their move over
and over again until the simulation is shut down.</p>

<h3 id="wakeupandmove">Wakeup_and_move</h3>
<p>When an ant receives a wakeup_and_move message, it has to figure where it wants
to move, if it can move there, and it needs to perform the pheromone propagation
step. I don’t want to let two ants occupy the same cell at once, but it isn’t so
bad if one ant is sort of in two places at once (I think). That rule results in
the following set of messages for an ant move.</p>

<ol>
  <li>The ant receives a wakeup_and_move message</li>
  <li>The ant sends a who_are_your_neighbors message to its current cell</li>
  <li>The current cell receives the who_are_your_neighbors message and sends the
ant a “neighbors” message with the list of its neighboring cells</li>
  <li>The ant decides which of these neighbors to move to using probabilities
explained earlier</li>
  <li>The ant performs the pheromone propagation step</li>
  <li>The ant sends a move_me_to_you message to its selected cell</li>
  <li>The selected cell checks if it is currently occupied
    <ul>
      <li>If it isn’t occupied, it sets its current occupant to the ant trying to and
sends a you_moved message back to the ant</li>
      <li>If it is occupied, it sends a move_failed message back to the ant</li>
    </ul>
  </li>
  <li>The ant receives either a move_failed or a you_moved message
    <ul>
      <li>If the ant received a you_moved message, it sends an ive_left message to
its current cell, updates its current cell to the selected cell, then goes
back to sleep</li>
      <li>If the ant receives a move_failed message, it does nothing and goes back
to sleep</li>
    </ul>
  </li>
</ol>

<h5 id="sequence-diagram">Sequence Diagram:</h5>

<p><a href="/img/ants/sequence.png"><img src="/img/ants/sequence.png" alt="sequence diagram" /></a></p>

<p>If you look carefully, you might notice that between steps 7 and 8, two cells
think they are occupied by the same ant. This prevent collisions but introduces
this strange “ant in flux” state. I would rather accept the double occupancy
issue than the collision issue.</p>

<h2 id="getting-the-data-out">Getting the data out</h2>
<p>As the simulation runs, the ants are generating all sorts of data that should
probably be recorded somewhere. This is a bit of a challenge because there is no
single entity that knows the state of the entire system at any given time, so
you can’t just ask it to record a sample of the state of the simulation
somewhere every once and a while.</p>

<p>My first attempt at this failed. I made a single process, called the “reporter”
that was responsible for aggregating all of the events (ants moving) and writing
them to disk. This almost worked.</p>

<p>To explain what went wrong, we need to take a diversion for a moment.</p>

<h3 id="message-prioritization">Message Prioritization</h3>

<p>My first attempt at a reporter had a pretty big issue with this, because it
prioritized the “stop” message, and I/O to disk is pretty slow. Every time the
reporter tried to handle a new message, it would first scan the mailbox for a
“stop” message, then go handle the first message on the queue. While handling
this message (slow, because it often did some disk I/O), that queue would grow
quite a bit. At one point, there were 53 million messages in the reporter queue,
that were getting scanned every time the reporter attempted to handle a new
message. Ouch.</p>

<h2 id="building-the-visualizations">Building the visualizations</h2>

<h2 id="conclusions">Conclusions</h2>

<h2 id="other-erlang-notes">Other Erlang Notes</h2>
<p>Message priority is sort of important in this simulation. For example, imagine
that some misbehaving process sends an ant two wakeup_and_move messages in a
row, where the second one is sent before the ant is done dealing with the first
one.</p>

<p>The ants mailbox would look like this: [wakeup_and_move, wakeup_and_move].</p>

<p>Then, the ant handles the first wakeup by sending a message to its current cell
to ask for its neighbors. The cell could then send the ant a list of its
neighbors. Whether or not the cell actually gets a chance to run depends on the
behavior of the scheduler, so this example is one of many possible behaviors the
system might exhibit.</p>

<p>Assuming the scheduler behaves the way I’m pretending it would the ant’s mailbox
is this: [wakeup_and_move, neighbors].</p>

<p>So, the ant, again, sends a message to its current cell, asking for its
neighbors.</p>

<p>Mailbox: [neighbors, neighbors].</p>

<p>Now we have a problem. When an ant handles a neighbors message, it picks a new
cell to move to, somewhat at random. So this ant will pick a new cell to move
to, twice in a row. There is a pretty good chance these two cells will not be
the same cell. So the ant is probably going to end up trying to go in two
different directions, and it might actually succeed and create quite a confusion.</p>

<p>There are all sort of opportunities for issues like this through the simulation.
One of the approaches the Erlang community uses to solve this problem is
selectively receiving messages at different points in the process excecution.</p>

<p>Here is an example of how something like this looks for the ant actor:</p>

<div class="highlight"><pre><code class="language-erlang" data-lang="erlang"><span class="nf">inner_loop</span><span class="p">(</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">receive</span>
        <span class="n">neighbors</span> <span class="o">-&gt;</span> <span class="n">handle_neighbors</span><span class="p">(</span><span class="nv">State</span><span class="p">),</span> <span class="n">inner_loop</span><span class="p">(</span><span class="nv">State</span><span class="p">);</span>
        <span class="p">...</span>
        <span class="n">move_failed</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">(</span><span class="nv">State</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span>

<span class="nf">loop</span><span class="p">(</span><span class="nv">State</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">receive</span>
        <span class="n">wakeup_and_move</span> <span class="o">-&gt;</span> <span class="n">inner_loop</span><span class="p">(</span><span class="nv">State</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span></code></pre></div>

<p>So when the ant is in it’s outer loop, it can only receive a wakeup_and_move
message. Once it receives one of those, it moves to an inner loop that can
receiver neighbors messages, and move failed messages, but leaves any other
message in the mailbox.</p>

<p>This way, after receiving a wakeup_and_move message, the ant can’t receive
another wakeup and move message until it returns to the outer loop.</p>

<p>This still doesn’t totally solve the problem. A badly behaved process could
still decide to send multiple neighbors messages and really screw things up for
everyone.</p>

<p>There is a serious downside to this approach though. In Erlang, when a process
(actor) gets to a receive block, it does a linear scan of its mailbox, from
newest message to oldest message to see if it can find anything that matches the
messages in the current receive block.</p>

<p>Therefore, you can imagine a badly behaved process generating a ton of
wakeup_and_move messages that flood an ants mailbox while the ant is in the
inner_loop receive block. Then, when attempting to handle a new message, the ant
would have to scan through the entire list of messages until it found the right
one. This can be pretty slow, and, as the mailboxes grow, the memory consumption
grows.</p>

</article>







      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    <div class="measure mt1 center">
      <small>
        Theme crafted with &lt;3 by <a href="http://johnotander.com">John Otander</a> (<a href="https://twitter.com/4lpine">@4lpine</a>).<br>
      </small>
    </div>
  </div>
</footer>



<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

</body>
</html>
